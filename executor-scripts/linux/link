#!/bin/sh
[ -n "$VERBOSE" ] && set -x

is_vlan() {
	case "$IFACE" in
	*#*) return 1 ;;
	*:*) return 1 ;;
	vlan*.*) return 1 ;;
	vlan*)
		[ -z "$IF_VLAN_RAW_DEVICE" ] && return 1
		IF_VLAN_ID="${IFACE#vlan}"
		;;
	*.*)
		IF_VLAN_RAW_DEVICE="${IFACE%.*}"
		IF_VLAN_ID="${IFACE##*.}"
		;;
	*)
		[ -z "$IF_VLAN_RAW_DEVICE" ] && return 1
		[ -z "$IF_VLAN_ID" ] && return 1
		;;
	esac
	return 0
}

case "$PHASE" in
depend)
	# vlan-raw-device
	if is_vlan; then
		printf '%s\n' "$IF_VLAN_RAW_DEVICE"

	# veth-peer-name
	elif [ "${IF_LINK_TYPE}" = "veth" ] && [ "${IF_VETH_PEER_NAME}" ]; then
		printf '%s\n' "$IF_VETH_PEER_NAME"
	fi
	;;

create)
	if [ "${IF_LINK_TYPE}" = "dummy" ]; then
		if [ ! -d /sys/module/dummy ]; then
			printf 'Loading dummy network interface kernel module\n'
			${MOCK} modprobe dummy
		fi

		if [ -z "${MOCK}" ]; then
			if [ -d "/sys/class/net/${IFACE}" ]; then
				if [ ! -d "/sys/devices/virtual/net/${IFACE}" ]; then
					printf 'Interface %s exists but is not a virtual interface\n' "$IFACE"
					exit 1
				fi

				exit 0
			fi
		fi

		${MOCK} ip link add "${IFACE}" type dummy

	elif [ "${IF_LINK_TYPE}" = "veth" ]; then
		if [ ! -d "/sys/class/net/${IFACE}" ]; then
			ARGS=""
			if [ "${IF_VETH_PEER_NAME}" ]; then
				ARGS="peer ${IF_VETH_PEER_NAME}"
			fi

			${MOCK} ip link add "${IFACE}" type veth ${ARGS}
		fi

	elif is_vlan; then

		if [ -z "${MOCK}" ]; then
			if [ -d "/sys/class/net/${IFACE}" ]; then
				exit 0
			fi
			if [ ! -d "/sys/class/net/${IF_VLAN_RAW_DEVICE}" ]; then
				printf 'Interface %s is missing VLAN raw device %s\n' "$IFACE" "$IF_VLAN_RAW_DEVICE"
				exit 1
			fi

			if ! [ -d /proc/net/vlan ]; then
				printf 'Loading 8021q kernel module for VLAN support\n'
				${MOCK} modprobe 8021q
			fi
		fi

		${MOCK} ip link add link "${IF_VLAN_RAW_DEVICE}" name "${IFACE}" type vlan id "${IF_VLAN_ID}"
	fi
	;;
up)
	[ -n "$IF_MTU" ] && IF_LINK_OPTIONS="$IF_LINK_OPTIONS mtu $IF_MTU"
	[ -n "$IF_HWADDRESS" ] && IF_LINK_OPTIONS="$IF_LINK_OPTIONS address $IF_HWADDRESS"

	${MOCK} ip link set up dev "${IFACE}" ${IF_LINK_OPTIONS}

	# Set alias is configured
	if [ "${IF_ALIAS}" ]; then
		${MOCK} ip link set alias "${IF_ALIAS}" dev "${IFACE}"
	fi
	;;
down)
	# Don't complain about a vanished interface when downing it
	if [ -z "${MOCK}" ] && [ ! -d "/sys/class/net/${IFACE}" ]; then
		exit 0
	fi

	${MOCK} ip link set down dev "${IFACE}"
	;;
destroy)
	if [ "${IF_LINK_TYPE}" = "dummy" ] || [ "${IF_LINK_TYPE}" = "veth" ] || is_vlan; then
		if [ -z "${MOCK}" ] && [ ! -d "/sys/class/net/${IFACE}" ]; then
			exit 0
		fi

		${MOCK} ip link del "${IFACE}"
	fi
	;;
esac
